<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Escaleta Hub ‚Äî Clean Blue</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ---------- Reset + base ---------- */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#f3f6fb 0%, #eef4fb 100%);
      color:#0f1724;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* ---------- Layout ---------- */
    .opening-screen{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(7,27,77,0.85), rgba(8,29,77,0.95));
      color:white; z-index:999;
    }
    .open-card{
      width:96%; max-width:520px; background:rgba(255,255,255,0.04); border-radius:12px; padding:28px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.5); border:1px solid rgba(255,255,255,0.06);
    }
    .logo{font-weight:700; letter-spacing:3px; color:#9ed0ff; font-size:34px}
    .tagline{color:rgba(255,255,255,0.85); margin-top:6px; font-size:14px}
    .login-form{margin-top:18px}

    .login-form label{display:block; font-size:13px; color:rgba(255,255,255,0.8); margin-bottom:6px}
    .login-input{width:100%; padding:12px 14px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.03); color:white}
    .login-btn{
      width:100%; margin-top:14px; padding:12px 14px; border-radius:10px; border:none; cursor:pointer;
      background:linear-gradient(90deg,#2563eb,#1d4ed8); color:white; font-weight:600;
      box-shadow: 0 6px 18px rgba(37,99,235,0.18);
    }

    /* Main platform */
    .main-platform{display:none; height:100vh; width:100%; display:flex; flex-direction:column;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 26px; background:linear-gradient(90deg,#1e3a8a,#2563eb);
      color:white; box-shadow: 0 6px 18px rgba(2,6,23,0.12);
    }
    .header-left{display:flex; align-items:center; gap:18px}
    .title-brand{display:flex; gap:12px; align-items:center}
    .brand-mark{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700;color:#e6f0ff}
    .app-title{font-weight:700; font-size:18px}
    .document-info input{background:transparent;border:none;color:rgba(255,255,255,0.95); font-weight:600; width:220px}
    .header-right{display:flex; gap:10px; align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-ghost{background:rgba(255,255,255,0.06); color:white}
    .btn-primary{background:linear-gradient(90deg,#60a5fa,#3b82f6); color:white; box-shadow:0 6px 16px rgba(59,130,246,0.16)}

    .container{
      display:flex; flex:1; height:calc(100vh - 72px); overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      width:260px; background:#0f1724; color:#e6eef8; padding:18px; display:flex; flex-direction:column; gap:12px;
      border-right: 1px solid rgba(255,255,255,0.03);
    }
    .sidebar h3{margin:0; font-size:13px; color:#9fb7de; padding-left:6px; margin-bottom:6px}
    .nav-btn{display:flex; gap:12px; align-items:center; padding:10px; border-radius:8px; cursor:pointer; border:none; background:transparent; color:inherit; text-align:left; font-weight:700}
    .nav-btn:hover{background:rgba(255,255,255,0.02)}
    .nav-btn.active{background:linear-gradient(90deg, rgba(96,165,250,0.12), rgba(59,130,246,0.06)); color:#cfe8ff}
    .nav-btn i{width:20px; text-align:center; font-size:16px}

    .sidebar .grow{flex:1}
    .small-muted{font-size:12px; color:#93b0db}

    /* Workspace */
    .workspace{flex:1; display:flex; flex-direction:column; overflow:hidden; padding:18px}
    .tab-header{display:flex; gap:10px; align-items:center; margin-bottom:12px}
    .tab-button{padding:10px 14px; border-radius:8px; background:transparent; border:none; cursor:pointer; font-weight:700; color:#0b1220}
    .tab-button.active{background:#fff; box-shadow: 0 8px 18px rgba(2,6,23,0.06)}
    .editor-area{flex:1; display:flex; overflow:hidden; gap:16px}

    /* editor column */
    .editor-column{flex:1; display:flex; flex-direction:column; gap:12px; overflow:hidden}
    .panel{background:#fff; border-radius:10px; padding:16px; border:1px solid rgba(15,23,36,0.06); box-shadow:0 8px 18px rgba(2,6,23,0.04); overflow:auto}
    .panel h4{margin:0 0 8px 0; font-size:15px; color:#0f1724}
    .panel p{color:#334155}

    /* script editor (roteiro) */
    .script-editor{
      padding:20px; background:#ffffff; color:#0f1724; min-height:300px; font-family: "Courier New", monospace; font-size:14px; line-height:1.6;
      border-radius:8px; border:1px solid rgba(2,6,23,0.04); overflow:auto;
    }
    .scene-heading{font-weight:800; color:#2563eb; text-transform:uppercase; margin-top:12px}
    .action, .dialogue, .character{margin:8px 0}

    /* argumento (textarea) */
    .argumento-editor{width:100%; min-height:260px; padding:12px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); resize:vertical; font-size:14px; color:#0f1724}

    /* toolbar for escaleta */
    .format-toolbar{display:flex; gap:8px; align-items:center; background:#f8fafc; padding:8px; border-radius:8px; border:1px solid rgba(15,23,36,0.04)}
    .format-toolbar button{background:transparent;border:none;padding:8px;border-radius:6px;cursor:pointer; font-size:14px}
    .format-toolbar button:hover{background:rgba(37,99,235,0.06)}
    .escaleta-editor{min-height:300px; padding:16px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); background:white; color:#0f1724; overflow:auto}

    /* storyboard */
    .storyboard-container{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px}
    .storyboard-item{background:#fff;border-radius:8px; overflow:hidden; border:1px solid rgba(2,6,23,0.04)}
    .storyboard-canvas{height:160px;background:#eef2ff; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#334155}

    /* footer */
    footer{height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:transparent; color:#334155; font-size:13px}

    /* floating buttons */
    .floating-buttons{position:fixed; right:22px; bottom:22px; display:flex; flex-direction:column; gap:12px; z-index:1200}
    .float-btn{width:56px;height:56px;border-radius:14px;border:none;background:linear-gradient(180deg,#2563eb,#1e40af); color:white; font-size:18px; cursor:pointer; box-shadow:0 8px 26px rgba(37,99,235,0.18)}
    .float-window{position:fixed; right:22px; bottom:100px; width:340px; max-height:520px; background:white; border-radius:10px; box-shadow:0 18px 50px rgba(2,6,23,0.18); overflow:hidden; display:none; flex-direction:column; z-index:1300}
    .float-window header{padding:10px 12px; background:linear-gradient(90deg,#2563eb,#1e40af); color:white; display:flex; justify-content:space-between; align-items:center}
    .float-body{padding:12px; display:flex; flex-direction:column; gap:8px; overflow:auto}
    .chat-messages{max-height:340px; overflow:auto; display:flex; flex-direction:column; gap:8px}
    .message{padding:8px 10px; border-radius:8px; max-width:80%}
    .message.user{align-self:flex-end; background:linear-gradient(90deg,#60a5fa,#3b82f6); color:white}
    .message.bot{align-self:flex-start; background:#f1f5f9; color:#0f1724}
    .chat-input{display:flex; gap:8px; padding:10px; border-top:1px solid rgba(2,6,23,0.04)}
    .chat-input input{flex:1; padding:10px; border-radius:8px; border:1px solid rgba(2,6,23,0.06)}

    /* responsive */
    @media (max-width:980px){
      .sidebar{display:none}
      .container{flex-direction:column}
      .main-platform header .document-info input{width:120px}
    }
  </style>
</head>
<body>
  <!-- opening -->
  <div class="opening-screen" id="openingScreen">
    <div class="open-card">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div class="logo">ESCALETA HUB</div>
          <div class="tagline">Sua plataforma profissional de cria√ß√£o de roteiros ‚Äî vers√£o clean</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:rgba(255,255,255,0.7)">v.1.0 ‚Äî Clean Blue</div>
        </div>
      </div>

      <div class="login-form">
        <label for="email">E-mail</label>
        <input id="email" class="login-input" type="email" placeholder="seu@email.com">
        <label for="password" style="margin-top:10px">Senha</label>
        <input id="password" class="login-input" type="password" placeholder="Sua senha">
        <button id="loginBtn" class="login-btn">Entrar</button>
      </div>
    </div>
  </div>

  <!-- main -->
  <div class="main-platform" id="mainPlatform">
    <header>
      <div class="header-left">
        <div class="title-brand">
          <div class="brand-mark">EH</div>
          <div>
            <div class="app-title">Escaleta Hub</div>
            <div class="small-muted" id="header-sub">Editor de roteiros</div>
          </div>
        </div>

        <div class="document-info" style="margin-left:18px">
          <input id="documentTitle" value="Roteiro Sem T√≠tulo" />
        </div>
      </div>

      <div class="header-right">
        <button id="saveBtn" class="btn btn-ghost"><i class="fas fa-save"></i> Salvar</button>
        <button id="exportBtn" class="btn btn-ghost"><i class="fas fa-file-export"></i> Exportar</button>
        <button id="modeToggle" class="btn btn-ghost"><i class="fas fa-adjust"></i> Tema</button>
      </div>
    </header>

    <div class="container">
      <aside class="sidebar">
        <h3><i class="fas fa-film"></i> Elementos</h3>

        <button class="nav-btn active" data-tab="roteiro-tab"><i class="fas fa-file-alt"></i> Roteiro</button>
        <button class="nav-btn" data-tab="argumento-tab"><i class="fas fa-feather-alt"></i> Argumento</button>
        <button class="nav-btn" data-tab="rascunho-tab"><i class="fas fa-edit"></i> Rascunho</button>
        <button class="nav-btn" data-tab="biblia-tab"><i class="fas fa-book"></i> B√≠blia</button>
        <button class="nav-btn" data-tab="escaleta-tab"><i class="fas fa-list-ol"></i> Escaleta</button>
        <button class="nav-btn" data-tab="storyboard-tab"><i class="fas fa-palette"></i> Storyboard</button>

        <div class="grow"></div>

        <div class="small-muted">Projeto ‚Ä¢ Escaleta Hub</div>
      </aside>

      <main class="workspace">
        <!-- tabs -->
        <div class="tab-header">
          <button class="tab-button active" data-tab="roteiro-tab">Roteiro</button>
          <button class="tab-button" data-tab="argumento-tab">Argumento</button>
          <button class="tab-button" data-tab="rascunho-tab">Rascunho</button>
          <button class="tab-button" data-tab="biblia-tab">B√≠blia</button>
          <button class="tab-button" data-tab="escaleta-tab">Escaleta</button>
          <button class="tab-button" data-tab="storyboard-tab">Storyboard</button>
        </div>

        <div class="editor-area">
          <!-- Roteiro -->
          <section id="roteiro-tab" class="panel" style="display:block;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
              <h4>Editor de Roteiro</h4>
              <div style="font-size:13px; color:#64748b">Palavras: <span id="roteiro-wordcount">0</span></div>
            </div>
            <div id="scriptEditor" class="script-editor" contenteditable="true" spellcheck="true">
<div class="scene-heading">INT. CASA DE JO√ÉO - DIA</div>
<div class="action">Uma casa simples. JO√ÉO mexe em pap√©is sobre a mesa.</div>
<div class="character">JO√ÉO</div>
<div class="dialogue">Onde ela est√°? J√° era para ter chegado.</div>
            </div>
          </section>

          <!-- Argumento -->
          <section id="argumento-tab" class="panel" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
              <h4>Argumento</h4>
              <div style="font-size:13px; color:#64748b">Palavras: <span id="argumento-wordcount">0</span></div>
            </div>

            <textarea id="argumentoEditor" class="argumento-editor" placeholder="Escreva o argumento geral do seu roteiro..."></textarea>

            <div style="margin-top:12px;">
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn btn-ghost" id="argumento-export"><i class="fas fa-download"></i> Exportar</button>
                <button class="btn btn-ghost" id="argumento-clear">Limpar</button>
              </div>
            </div>
          </section>

          <!-- Rascunho -->
          <section id="rascunho-tab" class="panel" style="display:none;">
            <h4>Rascunho</h4>
            <textarea id="rascunhoEditor" class="argumento-editor" placeholder="Anote ideias soltas, frases e testes..."></textarea>
            <div style="margin-top:10px; display:flex; gap:8px"><button class="btn btn-ghost" id="rascunho-save">Salvar</button><button class="btn btn-ghost" id="rascunho-clear">Limpar</button></div>
          </section>

          <!-- Biblia -->
          <section id="biblia-tab" class="panel" style="display:none;">
            <h4>B√≠blia do Projeto</h4>
            <div contenteditable="true" id="bibliaEditor" style="min-height:260px; padding:12px; border-radius:8px; border:1px solid rgba(15,23,36,0.06); background:white; color:#0f1724">
              <h3>Sinopse</h3>
              <p>Uma hist√≥ria sobre Jo√£o e Maria, dois personagens em uma jornada emocionante cheia de reviravoltas.</p>
              <h3>Personagens</h3>
              <p><strong>Jo√£o:</strong> Protagonista, 35 anos.</p>
            </div>
          </section>

          <!-- Escaleta -->
          <section id="escaleta-tab" class="panel" style="display:none;">
            <h4>Escaleta</h4>

            <div class="format-toolbar" style="margin-bottom:10px; align-items:center;">
              <button data-cmd="bold" title="Negrito (Ctrl/Cmd+B)"><i class="fas fa-bold"></i></button>
              <button data-cmd="italic" title="It√°lico (Ctrl/Cmd+I)"><i class="fas fa-italic"></i></button>
              <button data-cmd="underline" title="Sublinhado (Ctrl/Cmd+U)"><i class="fas fa-underline"></i></button>
              <button data-cmd="insertUnorderedList" title="Lista"><i class="fas fa-list-ul"></i></button>
              <button data-cmd="insertOrderedList" title="Lista ordenada"><i class="fas fa-list-ol"></i></button>
              <div style="flex:1"></div>
              <button class="btn btn-ghost" id="escaleta-export"><i class="fas fa-download"></i> Exportar</button>
            </div>

            <div id="escaletaEditor" class="escaleta-editor" contenteditable="true">Organize a sequ√™ncia das cenas aqui...</div>
          </section>

          <!-- Storyboard -->
          <section id="storyboard-tab" class="panel" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
              <h4>Storyboard</h4>
              <div style="display:flex; gap:8px">
                <button class="btn btn-ghost" id="addStoryboard">Adicionar quadro</button>
                <button class="btn btn-ghost" id="storyboard-export">Exportar imagens</button>
              </div>
            </div>

            <div class="storyboard-container" id="storyboardContainer">
              <div class="storyboard-item">
                <div class="storyboard-canvas" data-id="1"><span>Clique para desenhar</span></div>
                <div class="storyboard-info" style="padding:12px">
                  <p><strong>Cena 1:</strong> INT. CASA DE JO√ÉO - DIA</p>
                  <textarea placeholder="Descri√ß√£o..." rows="2" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(2,6,23,0.06)"></textarea>
                </div>
              </div>

              <div class="storyboard-item">
                <div class="storyboard-canvas" data-id="2"><span>Clique para desenhar</span></div>
                <div class="storyboard-info" style="padding:12px">
                  <p><strong>Cena 2:</strong> EXT. RUA - CONT√çNUO</p>
                  <textarea placeholder="Descri√ß√£o..." rows="2" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(2,6,23,0.06)"></textarea>
                </div>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>

    <footer>
      <div><i class="fas fa-keyboard"></i> <kbd>Ctrl+S</kbd> salvar | <kbd>Ctrl+N</kbd> nova cena</div>
      <div id="footerStatus">Auto-salvo: <span id="lastSaved">agora</span></div>
    </footer>
  </div>

  <!-- Floating Buttons -->
  <div class="floating-buttons">
    <button id="openChat" class="float-btn" title="Chat"><i class="fas fa-comments"></i></button>
    <button id="openVideo" class="float-btn" title="Chamada de V√≠deo"><i class="fas fa-video"></i></button>
  </div>

  <!-- Chat Window -->
  <div class="float-window" id="chatWindow" style="right:22px; bottom:100px; display:none; flex-direction:column;">
    <header>
      <div>Chat ‚Äî Assistente</div>
      <div><button id="closeChat" style="background:none;border:none;color:white;font-size:18px">&times;</button></div>
    </header>

    <div class="float-body">
      <div class="chat-messages" id="chatMessages"></div>
    </div>

    <div class="chat-input">
      <input id="chatInput" placeholder="Digite uma mensagem..." />
      <button id="chatSend" class="btn btn-primary">Enviar</button>
    </div>
  </div>

  <!-- Video Window -->
  <div class="float-window" id="videoWindow" style="right:380px; bottom:100px; width:360px; display:none; flex-direction:column;">
    <header>
      <div>Chamada de V√≠deo</div>
      <div><button id="closeVideo" style="background:none;border:none;color:white;font-size:18px">&times;</button></div>
    </header>
    <div style="height:260px; background:#111; display:flex; align-items:center; justify-content:center;">
      <video id="videoEl" autoplay playsinline style="width:100%; height:100%; object-fit:cover; background:#000"></video>
    </div>
    <div style="padding:10px; display:flex; gap:8px; align-items:center; justify-content:flex-end;">
      <button id="toggleMic" class="btn btn-ghost">Microfone</button>
      <button id="toggleCam" class="btn btn-ghost">C√¢mera</button>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    // ---------- Login / Open ----------
    const openingScreen = $('#openingScreen');
    const mainPlatform = $('.main-platform');
    const loginBtn = $('#loginBtn');
    loginBtn.addEventListener('click', () => {
      const email = $('#email').value.trim();
      const pass = $('#password').value.trim();
      if(!email || !pass){ alert('Preencha e-mail e senha'); return; }
      openingScreen.style.display = 'none';
      document.querySelector('.main-platform').style.display = 'flex';
      // load saved data
      loadAll();
    });

    // ---------- Tabs (sidebar + top) ----------
    function activateTab(tabId){
      // panels
      const panels = ['roteiro-tab','argumento-tab','rascunho-tab','biblia-tab','escaleta-tab','storyboard-tab'];
      panels.forEach(p => {
        const el = document.getElementById(p);
        if(el) el.style.display = (p===tabId) ? 'block' : 'none';
      });
      // top buttons
      $$('.tab-button').forEach(b => b.classList.toggle('active', b.dataset.tab===tabId));
      // sidebar
      $$('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.tab===tabId));
      // header subtitle
      const label = $(`.tab-button[data-tab="${tabId}"]`).textContent.trim();
      $('#header-sub').textContent = label;
      // update counters
      updateWordCounts();
    }
    // top and sidebar wiring
    $$('.tab-button').forEach(b => b.addEventListener('click', ()=>activateTab(b.dataset.tab)));
    $$('.nav-btn').forEach(b => b.addEventListener('click', ()=>activateTab(b.dataset.tab)));

    // ---------- Word counters ----------
    function countWords(text){
      const clean = text.replace(/\s+/g,' ').trim();
      if(!clean) return 0;
      return clean.split(' ').length;
    }

    function updateWordCounts(){
      const roteiroText = $('#scriptEditor').innerText || '';
      $('#roteiro-wordcount').textContent = countWords(roteiroText);
      const argText = $('#argumentoEditor').value || '';
      $('#argumento-wordcount').textContent = countWords(argText);
    }
    $('#scriptEditor').addEventListener('input', updateWordCounts);
    $('#argumentoEditor').addEventListener('input', updateWordCounts);

    // ---------- Formatting toolbar (escaleta) ----------
    $$('.format-toolbar button').forEach(b => {
      b.addEventListener('click', ()=> {
        const cmd = b.dataset.cmd;
        document.execCommand(cmd, false, null);
        $('#escaletaEditor').focus();
      });
    });

    // keyboard shortcuts for formatting (Ctrl/Cmd + B/I/U)
    function handleFormattingShortcuts(e){
      const key = e.key.toLowerCase();
      if((e.ctrlKey || e.metaKey) && ['b','i','u'].includes(key)){
        e.preventDefault();
        if(key==='b') document.execCommand('bold');
        if(key==='i') document.execCommand('italic');
        if(key==='u') document.execCommand('underline');
      }
      // Ctrl+S save
      if((e.ctrlKey || e.metaKey) && key==='s'){
        e.preventDefault();
        saveAll();
      }
      // Ctrl+N new scene (in roteiro)
      if((e.ctrlKey || e.metaKey) && key==='n'){
        if(document.activeElement && document.activeElement.id==='scriptEditor'){
          e.preventDefault();
          addNewScene();
        }
      }
    }
    document.addEventListener('keydown', handleFormattingShortcuts);

    // ---------- New Scene (Roteiro) ----------
    function addNewScene(){
      const editor = $('#scriptEditor');
      const el = document.createElement('div');
      el.className = 'scene-heading';
      el.contentEditable = 'true';
      el.textContent = 'INT. NOVA CENA - DIA';
      editor.appendChild(el);
      const action = document.createElement('div');
      action.className = 'action';
      action.contentEditable = 'true';
      action.textContent = 'Descri√ß√£o da cena...';
      editor.appendChild(action);
      editor.focus();
      saveAll();
      updateWordCounts();
    }
    // bind ctrl+n via key handler above

    // ---------- Storyboard drawing ----------
    function makeCanvasDrawable(wrapper){
      wrapper.addEventListener('click', () => {
        // avoid creating multiple canvases
        if(wrapper.querySelector('canvas')) return;
        const c = document.createElement('canvas');
        c.width = wrapper.clientWidth;
        c.height = wrapper.clientHeight;
        c.style.width = '100%';
        c.style.height = '100%';
        c.style.cursor = 'crosshair';
        wrapper.innerHTML = '';
        wrapper.appendChild(c);
        const ctx = c.getContext('2d');
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#0f1724';

        let drawing = false;
        function pos(e){
          const rect = c.getBoundingClientRect();
          const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
          const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
          return {x,y};
        }

        c.addEventListener('mousedown', e => { drawing = true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
        c.addEventListener('touchstart', e => { drawing = true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });

        c.addEventListener('mousemove', e => { if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke();});
        c.addEventListener('touchmove', e => { if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke();});

        ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev => c.addEventListener(ev, ()=> drawing=false));
      });
    }
    // Attach to existing canvases
    $$('.storyboard-canvas').forEach(makeCanvasDrawable);

    // Add new storyboard item
    $('#addStoryboard').addEventListener('click', ()=>{
      const container = $('#storyboardContainer');
      const wrapper = document.createElement('div');
      wrapper.className = 'storyboard-item';
      wrapper.innerHTML = `<div class="storyboard-canvas"><span>Clique para desenhar</span></div>
        <div class="storyboard-info" style="padding:12px">
          <p><strong>Cena:</strong></p>
          <textarea placeholder="Descri√ß√£o..." rows="2" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(2,6,23,0.06)"></textarea>
        </div>`;
      container.appendChild(wrapper);
      makeCanvasDrawable(wrapper.querySelector('.storyboard-canvas'));
    });

    // ---------- Exports ----------
    function download(filename, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
    $('#exportBtn').addEventListener('click', ()=> {
      const title = $('#documentTitle').value || 'roteiro';
      const content = $('#scriptEditor').innerText;
      download(`${title}.txt`, content);
    });
    $('#argumento-export').addEventListener('click', ()=> {
      const content = $('#argumentoEditor').value || '';
      download('argumento.txt', content);
    });
    $('#escaleta-export').addEventListener('click', ()=> download('escaleta.txt', $('#escaletaEditor').innerText || ''));

    // storyboard export (images)
    $('#storyboard-export').addEventListener('click', ()=>{
      const canvases = $$('.storyboard-canvas canvas');
      if(canvases.length===0){ alert('Nenhum desenho encontrado. Crie um quadro primeiro.'); return; }
      canvases.forEach((c, idx)=>{
        c.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = `storyboard-${idx+1}.png`; document.body.appendChild(a); a.click(); a.remove();
        });
      });
    });

    // ---------- Autosave & localStorage ----------
    const LS_KEYS = {
      ROTEIRO: 'eh_roteiro',
      ARGUMENTO: 'eh_argumento',
      ESCALETA: 'eh_escaleta',
      RASCUNHO: 'eh_rascunho',
      BIBLIA: 'eh_biblia',
      TITLE: 'eh_title'
    };

    function saveAll(){
      localStorage.setItem(LS_KEYS.ROTEIRO, $('#scriptEditor').innerHTML);
      localStorage.setItem(LS_KEYS.ARGUMENTO, $('#argumentoEditor').value);
      localStorage.setItem(LS_KEYS.ESCALETA, $('#escaletaEditor').innerHTML);
      localStorage.setItem(LS_KEYS.RASCUNHO, $('#rascunhoEditor').value);
      localStorage.setItem(LS_KEYS.BIBLIA, $('#bibliaEditor').innerHTML);
      localStorage.setItem(LS_KEYS.TITLE, $('#documentTitle').value);
      $('#lastSaved').textContent = new Date().toLocaleTimeString();
      $('#footerStatus').style.opacity = 1;
      setTimeout(()=> { $('#footerStatus').style.opacity = 0.6 }, 1800);
    }

    function loadAll(){
      const r = localStorage.getItem(LS_KEYS.ROTEIRO);
      if(r) $('#scriptEditor').innerHTML = r;
      const a = localStorage.getItem(LS_KEYS.ARGUMENTO);
      if(a) $('#argumentoEditor').value = a;
      const e = localStorage.getItem(LS_KEYS.ESCALETA);
      if(e) $('#escaletaEditor').innerHTML = e;
      const rc = localStorage.getItem(LS_KEYS.RASCUNHO);
      if(rc) $('#rascunhoEditor').value = rc;
      const b = localStorage.getItem(LS_KEYS.BIBLIA);
      if(b) $('#bibliaEditor').innerHTML = b;
      const t = localStorage.getItem(LS_KEYS.TITLE);
      if(t) $('#documentTitle').value = t;
      updateWordCounts();
    }

    // auto-save interval
    setInterval(saveAll, 120000); // 2 minutos
    $('#saveBtn').addEventListener('click', saveAll);

    // small save buttons
    $('#rascunho-save').addEventListener('click', ()=> { localStorage.setItem(LS_KEYS.RASCUNHO, $('#rascunhoEditor').value); alert('Rascunho salvo');});
    $('#rascunho-clear').addEventListener('click', ()=> { $('#rascunhoEditor').value=''; localStorage.removeItem(LS_KEYS.RASCUNHO); });
    $('#argumento-clear').addEventListener && $('#argumento-clear').addEventListener('click', ()=> { $('#argumentoEditor').value=''; });

    // ---------- Chat (floating) with auto-responses ----------
    const chatWindow = $('#chatWindow');
    const chatMessages = $('#chatMessages');
    const chatInput = $('#chatInput');
    $('#openChat').addEventListener('click', ()=> chatWindow.style.display = 'flex');
    $('#closeChat').addEventListener('click', ()=> chatWindow.style.display = 'none');

    function appendMessage(text, who='bot'){
      const d = document.createElement('div');
      d.className = 'message ' + (who==='user' ? 'user' : 'bot');
      d.textContent = text;
      chatMessages.appendChild(d);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // simple assistant responses
    function assistantReply(userText){
      // very simple rule-based replies
      const txt = userText.toLowerCase();
      if(txt.includes('salvar') || txt.includes('save')) return "Para salvar, clique em Salvar no topo ou pressione Ctrl+S. Posso salvar por voc√™ agora se quiser.";
      if(txt.includes('export') || txt.includes('exportar')) return "Voc√™ pode exportar o documento com o bot√£o Exportar. Quer que eu gere um .txt do roteiro agora?";
      if(txt.includes('escaleta')) return "A Escaleta est√° dispon√≠vel na aba 'Escaleta'. Use os bot√µes de formata√ß√£o ou Ctrl+B/Ctrl+I/Ctrl+U.";
      if(txt.includes('ajuda') || txt.includes('help')) return "Me diga o que precisa: salvar, exportar, criar cena, abrir storyboard, ou dicas de estrutura.";
      // fallback
      return "Interessante ‚Äî posso ajudar com: salvar, exportar, criar nova cena, abrir storyboard. Pergunte algo espec√≠fico üòä";
    }

    $('#chatSend').addEventListener('click', ()=> {
      const v = chatInput.value.trim();
      if(!v) return;
      appendMessage(v,'user');
      chatInput.value = '';
      // bot reply with slight delay
      setTimeout(()=> {
        const reply = assistantReply(v);
        appendMessage(reply,'bot');
      }, 700 + Math.random()*900);
    });
    chatInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); $('#chatSend').click(); }});

    // ---------- Video call ----------
    const videoWindow = $('#videoWindow');
    const videoEl = $('#videoEl');
    let streamRef = null;

    $('#openVideo').addEventListener('click', async ()=>{
      // show window
      videoWindow.style.display = 'flex';
      try{
        streamRef = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        videoEl.srcObject = streamRef;
      }catch(err){
        alert('Erro ao ativar c√¢mera/mic: ' + err.message);
      }
    });
    $('#closeVideo').addEventListener('click', ()=>{
      videoWindow.style.display = 'none';
      if(streamRef){
        streamRef.getTracks().forEach(t => t.stop());
        streamRef = null;
      }
    });

    // toggle cam/mic
    $('#toggleCam').addEventListener('click', ()=>{
      if(!streamRef) return alert('Ative a chamada primeiro.');
      const videoTrack = streamRef.getVideoTracks()[0];
      videoTrack.enabled = !videoTrack.enabled;
      $('#toggleCam').textContent = videoTrack.enabled ? 'C√¢mera' : 'C√¢mera (off)';
    });
    $('#toggleMic').addEventListener('click', ()=>{
      if(!streamRef) return alert('Ative a chamada primeiro.');
      const audioTrack = streamRef.getAudioTracks()[0];
      audioTrack.enabled = !audioTrack.enabled;
      $('#toggleMic').textContent = audioTrack.enabled ? 'Microfone' : 'Microfone (off)';
    });

    // ---------- Misc UI binds ----------
    $('#documentTitle').addEventListener('change', saveAll);

    // initialize defaults
    (function init(){
      // show main when script loads? keep opening screen as gate
      // attach formatting click fallback if toolbar exists
      // ensure initial word count
      updateWordCounts();
    })();

    // load any autosaved content if platform already visible
    // (we load on login intentionally)
  </script>
</body>
</html>



















